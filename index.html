<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>風景スクリーンセーバー</title>
    <link rel="manifest" href="manifest.json">
    <!-- モバイル対応メタタグ（両方必要） -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="theme-color" content="#000000">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Helvetica Neue', Arial, sans-serif;
            overflow: hidden;
            background-color: #000;
            color: #fff;
            height: 100vh;
            width: 100vw;
            position: relative;
        }
        
        .loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100;
            transition: opacity 0.5s ease-in-out;
        }
        
        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
            margin-bottom: 20px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .background {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-size: cover;
            background-position: center;
            opacity: 0;
            transition: opacity 2s ease-in-out;
            z-index: 1;
        }

        .active {
            opacity: 1;
        }

        .clock-container {
            position: absolute;
            bottom: 10%;
            left: 50%;
            transform: translateX(-50%);
            z-index: 10;
            text-align: center;
            text-shadow: 0 0 20px rgba(0, 0, 0, 0.8);
        }

        .time {
            font-size: 8rem;
            font-weight: 200;
            letter-spacing: 4px;
        }

        .date {
            font-size: 2rem;
            font-weight: 300;
            margin-top: 0.5rem;
            opacity: 0.8;
        }

        .overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(to bottom, rgba(0,0,0,0.2) 0%, rgba(0,0,0,0.6) 100%);
            z-index: 2;
        }

        .photo-credit {
            position: absolute;
            bottom: 5px;
            right: 10px;
            font-size: 0.8rem;
            opacity: 0.7;
            z-index: 10;
            text-shadow: 0 0 4px rgba(0, 0, 0, 0.8);
        }

        .photo-credit a {
            color: #fff;
            text-decoration: none;
        }

        .photo-credit a:hover {
            text-decoration: underline;
        }

        @media (max-width: 768px) {
            .time {
                font-size: 5rem;
            }
            .date {
                font-size: 1.5rem;
            }
        }
    </style>
    <!-- Unsplash JavaScript API クライアント -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fetch-jsonp/1.1.3/fetch-jsonp.min.js"></script>
</head>
<body>
    <div class="loading" id="loading">
        <div class="spinner"></div>
        <div>美しい風景写真を読み込み中...</div>
    </div>

    <div class="overlay"></div>
    
    <!-- Backgrounds will be inserted here by JavaScript -->
    
    <div class="clock-container">
        <div class="time" id="time">00:00:00</div>
        <div class="date" id="date">2025年3月15日 土曜日</div>
    </div>

    <div class="photo-credit" id="photo-credit"></div>

    <script>
        // 使用する画像のキーワード
        const keywords = [
            'landscape,mountains',
            'landscape,ocean',
            'landscape,forest',
            'landscape,sunset',
            'landscape,winter'
        ];

        // Initialize variables
        let currentBgIndex = 0;
        let backgrounds = [];
        const imageCache = {};
        let imageCredits = [];
        let preloadComplete = false;

        // クエリパラメータを作成 (サイズやキーワードなど)
        function buildUnsplashUrl(keyword) {
            // CORSプロキシを使用（必要に応じて他のプロキシに置き換え）
            const corsProxy = 'https://corsproxy.io/?';
            // Unsplash APIのランダム写真エンドポイント
            const unsplashUrl = encodeURIComponent(`https://source.unsplash.com/1920x1080/?${keyword}`);
            return `${corsProxy}${unsplashUrl}`;
        }

        // Start the application
        document.addEventListener('DOMContentLoaded', () => {
            showLoadingIndicator();
            preloadImages().then(() => {
                hideLoadingIndicator();
                initializeBackgrounds();
                updateClock();
                setInterval(updateClock, 1000);
                setInterval(changeBackground, 20000); // Change background every 20 seconds
            }).catch(error => {
                console.error('Failed to load images:', error);
                // フォールバック処理（SVGでのダミー背景を使用）
                useFallbackImages();
                hideLoadingIndicator();
                initializeBackgrounds();
                updateClock();
                setInterval(updateClock, 1000);
                setInterval(changeBackground, 20000);
            });
        });

        // フォールバック画像を使用（エラー時）
        function useFallbackImages() {
            const colors = ['#1a365d', '#2a4365', '#2c5282', '#2b6cb0', '#3182ce'];
            keywords.forEach((keyword, index) => {
                const svgUrl = `data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='1920' height='1080' viewBox='0 0 1920 1080'%3E%3Crect width='1920' height='1080' fill='${colors[index]}' /%3E%3C/svg%3E`;
                imageCache[keyword] = svgUrl;
                imageCredits[index] = null;
            });
        }
        
        // 画像のプリロード処理
        async function preloadImages() {
            const promises = keywords.map((keyword, index) => {
                return new Promise((resolve, reject) => {
                    if (imageCache[keyword]) {
                        // 既にキャッシュされている場合は即時解決
                        resolve(keyword);
                        return;
                    }
                    
                    // Unsplash Source APIを使用して画像URLを取得
                    fetch(buildUnsplashUrl(keyword))
                        .then(response => {
                            if (!response.ok) {
                                throw new Error(`Failed to fetch image: ${response.statusText}`);
                            }
                            
                            // 実際の画像URLを取得（リダイレクト先）
                            const imageUrl = response.url;
                            
                            // クレジット情報を保存（実際のUnsplash APIではより詳細な情報が得られます）
                            const photographerName = "Unsplash Photographer";
                            const unsplashLink = "https://unsplash.com";
                            imageCredits[index] = {
                                name: photographerName,
                                link: unsplashLink
                            };
                            
                            // 画像を読み込む
                            const img = new Image();
                            img.onload = () => {
                                imageCache[keyword] = imageUrl;
                                resolve(keyword);
                            };
                            img.onerror = () => {
                                reject(new Error(`Failed to load image: ${imageUrl}`));
                            };
                            img.src = imageUrl;
                        })
                        .catch(reject);
                });
            });
            
            // すべての画像が読み込まれるのを待つ
            await Promise.allSettled(promises);
            preloadComplete = true;
            return true;
        }
        
        // Create background elements
        function initializeBackgrounds() {
            for (let i = 0; i < keywords.length; i++) {
                const bg = document.createElement('div');
                bg.className = 'background';
                // キャッシュから画像URLを取得
                const imageUrl = imageCache[keywords[i]];
                if (imageUrl) {
                    bg.style.backgroundImage = `url(${imageUrl})`;
                    if (i === 0) bg.classList.add('active');
                    document.body.appendChild(bg);
                    backgrounds.push(bg);
                }
            }
            // 最初の画像のクレジットを表示
            updatePhotoCredit(0);
        }

        // Update the clock
        function updateClock() {
            const now = new Date();
            
            // Time format
            const hours = now.getHours().toString().padStart(2, '0');
            const minutes = now.getMinutes().toString().padStart(2, '0');
            const seconds = now.getSeconds().toString().padStart(2, '0');
            
            // Date format for Japanese locale
            const options = { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric', 
                weekday: 'long'
            };
            const dateString = now.toLocaleDateString('ja-JP', options);
            
            // Update DOM
            document.getElementById('time').textContent = `${hours}:${minutes}:${seconds}`;
            document.getElementById('date').textContent = dateString;
        }

        // Change background image
        function changeBackground() {
            backgrounds[currentBgIndex].classList.remove('active');
            currentBgIndex = (currentBgIndex + 1) % backgrounds.length;
            backgrounds[currentBgIndex].classList.add('active');
            // 写真のクレジットを更新
            updatePhotoCredit(currentBgIndex);
        }

        // 写真のクレジット情報を更新
        function updatePhotoCredit(index) {
            const creditElement = document.getElementById('photo-credit');
            const credit = imageCredits[index];
            
            if (credit) {
                creditElement.innerHTML = `Photo by <a href="${credit.link}" target="_blank" rel="noopener">${credit.name}</a> on <a href="https://unsplash.com" target="_blank" rel="noopener">Unsplash</a>`;
            } else {
                creditElement.innerHTML = '';
            }
        }
        
        // ローディングインジケータを表示/非表示
        function showLoadingIndicator() {
            document.getElementById('loading').style.display = 'flex';
        }
        
        function hideLoadingIndicator() {
            const loading = document.getElementById('loading');
            loading.style.opacity = '0';
            setTimeout(() => {
                loading.style.display = 'none';
            }, 500);
        }
        
        // For PWA - basic service worker registration
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                // GitHubページ用の相対パス
                const swPath = window.location.pathname.includes('github.io') ? 
                    'landscape-screensaver/sw.js' : '/sw.js';
                
                navigator.serviceWorker.register(swPath).then(registration => {
                    console.log('ServiceWorker registered:', registration);
                }).catch(error => {
                    console.log('ServiceWorker registration failed:', error);
                });
            });
        }

        // Prevent screen from sleeping
        function keepAwake() {
            if (navigator.wakeLock) {
                navigator.wakeLock.request('screen').then(lock => {
                    console.log('Screen wake lock active');
                }).catch(err => {
                    console.error(`Screen wake lock error: ${err.name}, ${err.message}`);
                });
            }
        }
        
        // Enable fullscreen on click
        document.addEventListener('click', () => {
            if (document.documentElement.requestFullscreen) {
                document.documentElement.requestFullscreen();
                keepAwake();
            }
        });
    </script>
</body>
</html>