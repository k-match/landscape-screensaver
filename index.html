<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>風景スクリーンセーバー</title>
    <link rel="manifest" href="manifest.json">
    <link rel="icon" href="icon-192.png" type="image/png">
    <meta name="theme-color" content="#000000">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon" href="icon-192.png">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Helvetica Neue', Arial, sans-serif;
            overflow: hidden;
            background-color: #000;
            color: #fff;
            height: 100vh;
            width: 100vw;
            position: relative;
        }
        
        .loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100;
            transition: opacity 0.5s ease-in-out;
        }
        
        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
            margin-bottom: 20px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .background {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-size: cover;
            background-position: center;
            opacity: 0;
            transition: opacity 2s ease-in-out;
            z-index: 1;
        }

        .active {
            opacity: 1;
        }

        .clock-container {
            position: absolute;
            bottom: 10%;
            left: 50%;
            transform: translateX(-50%);
            z-index: 10;
            text-align: center;
            text-shadow: 0 0 20px rgba(0, 0, 0, 0.8);
        }

        .time {
            font-size: 8rem;
            font-weight: 200;
            letter-spacing: 4px;
        }

        .date {
            font-size: 2rem;
            font-weight: 300;
            margin-top: 0.5rem;
            opacity: 0.8;
        }

        .overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(to bottom, rgba(0,0,0,0.2) 0%, rgba(0,0,0,0.6) 100%);
            z-index: 2;
        }

        @media (max-width: 768px) {
            .time {
                font-size: 5rem;
            }
            .date {
                font-size: 1.5rem;
            }
        }
    </style>
</head>
<body>
    <div class="loading" id="loading">
        <div class="spinner"></div>
        <div>画像を読み込み中...</div>
    </div>

    <div class="overlay"></div>
    
    <!-- Backgrounds will be inserted here by JavaScript -->
    
    <div class="clock-container">
        <div class="time" id="time">00:00:00</div>
        <div class="date" id="date">2025年3月15日 土曜日</div>
    </div>

    <script>
        // Unsplashからリアルタイムで美しい風景画像を取得
        const landscapes = [
            'https://source.unsplash.com/1920x1080/?landscape,mountains',
            'https://source.unsplash.com/1920x1080/?landscape,ocean',
            'https://source.unsplash.com/1920x1080/?landscape,forest',
            'https://source.unsplash.com/1920x1080/?landscape,sunset',
            'https://source.unsplash.com/1920x1080/?landscape,winter'
        ];

        // Initialize variables
        let currentBgIndex = 0;
        let backgrounds = [];
        const imageCache = {}; // 画像キャッシュを保存するオブジェクト
        let preloadComplete = false;

        // Start the application
        document.addEventListener('DOMContentLoaded', () => {
            showLoadingIndicator();
            preloadImages().then(() => {
                hideLoadingIndicator();
                initializeBackgrounds();
                updateClock();
                setInterval(updateClock, 1000);
                setInterval(changeBackground, 20000); // Change background every 20 seconds
            });
        });
        
        // 画像のプリロード処理
        async function preloadImages() {
            const promises = landscapes.map(url => {
                return new Promise((resolve, reject) => {
                    if (imageCache[url]) {
                        // 既にキャッシュされている場合は即時解決
                        resolve(url);
                        return;
                    }
                    
                    // 新しい画像を読み込む
                    const img = new Image();
                    img.onload = () => {
                        imageCache[url] = img.src; // キャッシュに保存
                        resolve(url);
                    };
                    img.onerror = () => {
                        // エラー時はデフォルト画像を使用
                        console.error(`Failed to load image: ${url}`);
                        imageCache[url] = '/api/placeholder/1920/1080';
                        resolve(url);
                    };
                    img.src = url;
                });
            });
            
            // すべての画像が読み込まれるのを待つ
            await Promise.all(promises);
            preloadComplete = true;
            return true;
        }
        
        // Create background elements
        function initializeBackgrounds() {
            for (let i = 0; i < landscapes.length; i++) {
                const bg = document.createElement('div');
                bg.className = 'background';
                // キャッシュから画像URLを取得
                const imageUrl = imageCache[landscapes[i]] || landscapes[i];
                bg.style.backgroundImage = `url(${imageUrl})`;
                if (i === 0) bg.classList.add('active');
                document.body.appendChild(bg);
                backgrounds.push(bg);
            }
        }

        // Update the clock
        function updateClock() {
            const now = new Date();
            
            // Time format
            const hours = now.getHours().toString().padStart(2, '0');
            const minutes = now.getMinutes().toString().padStart(2, '0');
            const seconds = now.getSeconds().toString().padStart(2, '0');
            
            // Date format for Japanese locale
            const options = { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric', 
                weekday: 'long'
            };
            const dateString = now.toLocaleDateString('ja-JP', options);
            
            // Update DOM
            document.getElementById('time').textContent = `${hours}:${minutes}:${seconds}`;
            document.getElementById('date').textContent = dateString;
        }

        // Change background image
        function changeBackground() {
            backgrounds[currentBgIndex].classList.remove('active');
            currentBgIndex = (currentBgIndex + 1) % backgrounds.length;
            backgrounds[currentBgIndex].classList.add('active');
        }
        
        // ローディングインジケータを表示/非表示
        function showLoadingIndicator() {
            document.getElementById('loading').style.display = 'flex';
        }
        
        function hideLoadingIndicator() {
            const loading = document.getElementById('loading');
            loading.style.opacity = '0';
            setTimeout(() => {
                loading.style.display = 'none';
            }, 500);
        }
        
        // For PWA - basic service worker registration
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js').then(registration => {
                    console.log('ServiceWorker registered:', registration);
                }).catch(error => {
                    console.log('ServiceWorker registration failed:', error);
                });
            });
        }

        // Prevent screen from sleeping
        function keepAwake() {
            if (navigator.wakeLock) {
                navigator.wakeLock.request('screen').then(lock => {
                    console.log('Screen wake lock active');
                }).catch(err => {
                    console.error(`Screen wake lock error: ${err.name}, ${err.message}`);
                });
            }
        }
        
        // Enable fullscreen on click
        document.addEventListener('click', () => {
            if (document.documentElement.requestFullscreen) {
                document.documentElement.requestFullscreen();
                keepAwake();
            }
        });
    </script>
</body>
</html>
